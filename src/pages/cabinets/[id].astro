---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import pool from '../../lib/db';

const { id } = Astro.params;

const [rows] = await pool.execute("SELECT * FROM cabinets WHERE id = ?", [id]);
const cabinet = (rows as any[])[0];

if (!cabinet) {
  return Astro.redirect("/cabinets");
}

const [relatedRows] = await pool.execute(
  "SELECT * FROM cabinets WHERE id != ? AND tag = ? LIMIT 3", 
  [id, cabinet.tag]
);
let relatedCabinets = relatedRows as any[];

// Fallback if no cabinets with same tag
if (relatedCabinets.length === 0) {
  const [fallbackRows] = await pool.execute(
    "SELECT * FROM cabinets WHERE id != ? LIMIT 3",
    [id]
  );
  relatedCabinets = fallbackRows as any[];
}

const specs = cabinet.specifications 
  ? cabinet.specifications.split('\n').filter((s: string) => s.trim() !== '') 
  : [];
---

<Layout title={`${cabinet.name} | Cabinets | BA Kitchen & Bath Remodeling`}>
  <Header />
  <main>
    <!-- Hero Section -->
    <section 
      class="relative h-[60vh] min-h-[400px] flex items-end justify-start text-white px-6 md:px-[54px] pt-[110px] pb-10 md:pb-[80px] bg-cover bg-center" 
      style={`background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('/cabinets/Image_Header (4).webp');`}
    >
      <div class="reveal reveal-up">
        <h1 class="text-5xl md:text-[80px] leading-tight font-light text-white m-0">
          Cabinets
        </h1>
      </div>
    </section>

    <!-- Product Detail Section -->
    <section class="bg-beige-light px-6 md:px-[54px] lg:px-[140px] py-[110px]">
      <div class="max-w-[1200px] mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 lg:gap-32 items-start">
          
          <!-- Image Column -->
          <div class="reveal reveal-left">
            <div class="aspect-[1/1.5] flex items-center justify-center group overflow-hidden">
              <img 
                src={cabinet.image} 
                alt={cabinet.name} 
                class="w-full h-auto object-contain transform hover:scale-105 transition-transform duration-1000" 
              />
            </div>
          </div>

          <!-- Info Column -->
          <div class="flex flex-col reveal reveal-right">
            <span class="text-[12px] uppercase tracking-[0.25em] text-black-soft/40 font-bold mb-2">
              {cabinet.brand}
            </span>
            <h2 class="text-4xl md:text-[50px] font-light text-black-soft mb-8 leading-tight">
              {cabinet.name}
            </h2>
            
            <p class="text-[16px] text-black-soft/70 font-light mb-12 leading-relaxed">
              {cabinet.description}
            </p>

            <div class="mb-12">
              <h4 class="text-[14px] uppercase tracking-widest font-bold text-black-soft mb-6">{cabinet.series}</h4>
              <ul class="space-y-4">
                {specs.map(spec => (
                  <li class="flex items-start gap-3 text-[14px] text-black-soft/60 font-light">
                    <span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-gold/40 flex-shrink-0"></span>
                    {spec}
                  </li>
                ))}
              </ul>
            </div>

            <div class="flex items-center gap-4 pt-8 border-t border-black-soft/5">
              <span class="text-[14px] text-black-soft/60 font-light">Color:</span>
              <div class="w-6 h-6 rounded-sm border border-black-soft/10" style={`background-color: ${(cabinet.tag || '').toLowerCase() === 'white' ? '#fff' : (cabinet.tag || '').toLowerCase() === 'brown' ? '#5D4037' : (cabinet.tag || '').toLowerCase() === 'gray' ? '#9E9E9E' : '#1A237E'}`}></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Related Products -->
    <section class="bg-beige-light px-6 md:px-[54px] lg:px-[140px] pb-[110px]">
      <div class="max-w-[1200px] mx-auto border-t border-black-soft/5 pt-24">
        <h3 class="text-[14px] uppercase tracking-[0.3em] font-medium text-black-soft/40 mb-16 reveal reveal-up">Related</h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-20 gap-y-32">
          {relatedCabinets.map((item, index) => (
            <a href={`/cabinets/${item.id}`} class="flex flex-col gap-10 reveal reveal-up group" style={`animation-delay: ${index * 100}ms`}>
              <div class="max-w-[280px] mx-auto w-full flex flex-col gap-10">
                <div class="aspect-[1/1.5] w-full flex items-center justify-center overflow-hidden">
                  <img 
                    src={item.image} 
                    alt={item.name} 
                    class="w-full h-auto object-contain transform group-hover:scale-105 transition-transform duration-1000" 
                  />
                </div>
                <div class="flex flex-col gap-2 text-left whitespace-nowrap">
                  <span class="text-[9px] tracking-[0.1em] text-black-soft/40 font-medium">{item.brand}</span>
                  <h3 class="text-[16px] md:text-[18px] font-normal text-black-soft m-0 group-hover:text-gold transition-colors">{item.name}</h3>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="relative h-screen flex items-end overflow-hidden">
      <div 
        class="absolute inset-0 bg-cover bg-center transition-transform duration-[2000ms] hover:scale-105" 
        style="background-image: url('/cabinets/Image_Background (5).webp');"
      ></div>
      <div class="absolute inset-0 bg-black/20"></div>
      
      <div class="relative z-10 w-full px-6 md:px-[54px] lg:px-[140px] pb-16 md:pb-24 max-w-[1440px] mx-auto flex flex-col md:flex-row justify-between items-end gap-8">
        <div class="reveal reveal-left">
          <h2 class="text-3xl md:text-[42px] leading-tight font-light text-white max-w-[700px]">
            Contact us for a quick online estimate or to schedule an in-home consult.
          </h2>
        </div>
        <div class="reveal reveal-right">
          <a 
            href="/contact" 
            class="text-[12px] uppercase tracking-[0.3em] font-medium text-white border-b border-white hover:text-gold hover:border-gold transition-all duration-300 pb-2 mb-2 inline-block"
          >
            Start now
          </a>
        </div>
      </div>
    </section>
  </main>
</Layout>
