---
import pool from '../lib/db';

const [rows] = await pool.execute("SELECT * FROM projects ORDER BY created_at ASC, id ASC LIMIT 5");
const dbProjects = (rows as any[]).map(p => ({
  name: p.name,
  image: p.main_image,
  logo: p.logo_overlay,
  href: `/projects/${p.category.toLowerCase()}/${p.id}`
}));

// Double/Triple for infinite loop
const projects = [...dbProjects, ...dbProjects, ...dbProjects];
const originalCount = dbProjects.length;
---

<section class="bg-beige-light px-6 md:px-[54px] py-[110px] flex flex-col gap-12 overflow-hidden">
  <div class="flex justify-between items-end max-w-[1440px] mx-auto w-full reveal reveal-up">
    <h2 class="text-5xl md:text-[60px] leading-[1.1] font-normal text-black-soft m-0">
      Some projects
    </h2>
    <a href="/projects" class="text-[12px] uppercase tracking-widest text-black-soft/60 pb-1 border-b border-black-soft/20 hover:text-gold hover:border-gold transition-all duration-300">
      View all
    </a>
  </div>

  <div 
    id="carousel-container"
    class="relative w-full overflow-x-auto no-scrollbar flex gap-6 md:gap-[30px] pb-12 cursor-grab active:cursor-grabbing"
  >
    {projects.map((project, index) => (
      <div 
        class="min-w-[85vw] md:min-w-[calc(50%-15px)] lg:min-w-[480px] flex flex-col gap-6 project-card reveal reveal-up"
        data-index={index}
      >
        <a href={project.href} class="relative block aspect-[16/10] overflow-hidden group">
          <img 
            src={project.image} 
            alt={project.name} 
            class="w-full h-full object-cover grayscale-[30%] group-hover:grayscale-0 group-hover:scale-105 transition-all duration-700"
          />
          <div class="absolute inset-0 bg-black-soft/30 transition-opacity duration-500"></div>
          <div class="absolute inset-0 flex items-center justify-center p-12 pointer-events-none">
            <img 
              src={project.logo} 
              alt={`${project.name} logo`} 
              class="max-w-[220px] max-h-[100px] object-contain invert brightness-0"
            />
          </div>
        </a>
        <div class="flex flex-col gap-4">
          <h3 class="text-2xl md:text-[28px] font-normal text-black-soft m-0">
            {project.name}
          </h3>
          <a href={project.href} class="text-[14px] uppercase tracking-widest text-black-soft/40 hover:text-gold transition-colors duration-300 border-b border-black-soft/10 w-fit pb-1">
            View
          </a>
        </div>
      </div>
    ))}
  </div>
</section>

<script define:vars={{ originalCount }}>
  const container = document.getElementById('carousel-container');
  let isHovered = false;

  const initCarousel = () => {
    if (!container) return;

    const cards = container.querySelectorAll('.project-card');
    if (cards.length === 0) return;


    const cardWidthWithGap = cards[1].getBoundingClientRect().left - cards[0].getBoundingClientRect().left;

    // Start in the middle set
    container.scrollLeft = cardWidthWithGap * originalCount;

    const step = () => {
      if (!isHovered) {
        const currentScroll = container.scrollLeft;
        const totalWidth = container.scrollWidth;
        const thirdWidth = totalWidth / 3;

        // Seamless reset
        if (currentScroll >= thirdWidth * 2) {
          container.scrollTo({ left: currentScroll - thirdWidth, behavior: 'instant' as any });
        } else if (currentScroll <= 0) {
          container.scrollTo({ left: thirdWidth, behavior: 'instant' as any });
        }

        container.scrollBy({ left: cardWidthWithGap, behavior: 'smooth' });
      }
    };

    let interval = setInterval(step, 4000);

    container.addEventListener('mouseenter', () => isHovered = true);
    container.addEventListener('mouseleave', () => isHovered = false);
    container.addEventListener('touchstart', () => isHovered = true);
    container.addEventListener('touchend', () => isHovered = false);

    // Manual scroll sync: if user scrolls, we might want to sync, but snap handles most of it.
  };

  // Run on mount
  window.addEventListener('load', initCarousel);
</script>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  #carousel-container {
    scroll-snap-type: x mandatory;
  }
  .project-card {
    scroll-snap-align: start;
  }
</style>
