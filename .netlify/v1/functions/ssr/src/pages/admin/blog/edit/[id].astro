---
import AdminLayout from "../../../../layouts/AdminLayout.astro";
import { actions } from "astro:actions";
import pool from "../../../../lib/db";

const { id } = Astro.params;

// Fetch existing post
const [postRows] = await pool.execute("SELECT * FROM blog_posts WHERE id = ?", [id]);
const post = (postRows as any[])[0];

if (!post) {
  return Astro.redirect("/admin/blog");
}

// Fetch existing sections
const [sectionRows] = await pool.execute("SELECT * FROM blog_sections WHERE post_id = ? ORDER BY order_index ASC", [id]);
const sections = (sectionRows as any[]);

const result = Astro.getActionResult(actions.updateBlogPost);
if (result?.data?.success) {
  return Astro.redirect("/admin/blog");
}

// Prepare initial sections JSON for client-side
const initialSections = JSON.stringify(sections.map(s => ({
    id: s.id, // purely for keying if needed
    type: s.type,
    content: s.content_text,
    existing_image_1: s.image_path_1,
    existing_image_2: s.image_path_2
})));
---

<AdminLayout title="Edit Blog Post">
  <div class="max-w-[1600px] mx-auto flex flex-col gap-10 h-full">
    <header class="flex flex-col gap-2">
      <h1 class="text-[12px] uppercase tracking-[0.4em] text-black-soft/40 font-medium">Blog / Edit</h1>
      <h2 class="text-4xl md:text-[50px] font-light text-black-soft m-0 uppercase tracking-tight">Edit Post</h2>
    </header>

    <!-- Split View Container -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 h-full">
        
        <!-- Left: Form -->
        <div class="bg-white p-10 shadow-xl rounded-sm border border-black-soft/5 h-fit">
            <form id="blog-form" method="POST" action={actions.updateBlogPost} enctype="multipart/form-data" class="flex flex-col gap-10">
                <input type="hidden" name="id" value={post.id} />
                
                <!-- Main Info -->
                <div class="grid grid-cols-1 gap-8 border-b border-black-soft/5 pb-10">
                    <div class="flex flex-col gap-2">
                        <label for="title" class="text-[10px] uppercase tracking-[0.2em] text-black-soft/60">Post Title</label>
                        <input type="text" name="title" id="title" required value={post.title} class="border-b border-black-soft/20 py-2 focus:border-gold outline-none transition-colors font-light text-lg" />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label for="main_image" class="text-[10px] uppercase tracking-[0.2em] text-black-soft/60">Main Image (Leave empty to keep current)</label>
                        <input type="file" name="main_image" id="main_image" accept="image/*" class="font-light text-xs text-black-soft/60 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:uppercase file:tracking-widest file:bg-beige-light file:text-black-soft hover:file:bg-gold hover:file:text-white file:transition-colors" />
                         <img src={post.main_image} alt="Current" class="w-32 h-20 object-cover mt-2 rounded-sm bg-gray-100" />
                    </div>
                    <div class="flex flex-col gap-2">
                        <label for="short_description" class="text-[10px] uppercase tracking-[0.2em] text-black-soft/60">Short Description</label>
                        <textarea name="short_description" id="short_description" rows="3" class="border border-black-soft/10 p-4 focus:border-gold outline-none transition-colors font-light text-sm resize-none">{post.short_description}</textarea>
                    </div>
                </div>

                <!-- Dynamic Sections -->
                <div class="flex flex-col gap-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-[14px] uppercase tracking-[0.2em] text-black-soft font-medium">Content Sections</h3>
                        <button type="button" id="add-section-btn" class="bg-black-soft text-white px-6 py-2 uppercase tracking-widest text-[10px] hover:bg-gold transition-colors">
                            + Add Section
                        </button>
                    </div>

                    <div id="sections-container" class="flex flex-col gap-8">
                        <!-- Sections will be injected here -->
                    </div>
                </div>

                <!-- Hidden Input for JSON -->
                <input type="hidden" name="sections" id="sections-json" />

                <div class="flex justify-end gap-6 pt-10 border-t border-black-soft/5">
                    <a href="/admin/blog" class="px-8 py-4 uppercase tracking-[0.3em] text-[11px] font-medium text-black-soft/40 hover:text-black-soft transition-colors">Cancel</a>
                    <button type="submit" class="bg-gold text-white px-12 py-4 uppercase tracking-[0.3em] text-[11px] font-medium hover:bg-black-soft transition-colors shadow-lg">Update Post</button>
                </div>
            </form>
             {result?.error && (
                <p class="mt-6 text-red-500 text-xs font-light italic text-center">{result.error.message}</p>
            )}
        </div>

        <!-- Right: Live Preview -->
        <div class="hidden lg:block relative">
            <div class="sticky top-10 bg-white shadow-2xl rounded-sm border border-black-soft/5 overflow-hidden h-[800px] overflow-y-auto w-full">
                <!-- Preview Header -->
                <div class="bg-black-soft text-white p-4 text-[10px] uppercase tracking-widest text-center">Live Preview</div>
                
                <!-- Preview Content -->
                <div id="preview-area" class="bg-white">
                    <!-- Dynamic Preview Content -->
                </div>
            </div>
        </div>
    </div>
  </div>
</AdminLayout>

<!-- Inject Initial Data -->
<script define:vars={{ initialSections, post }}>
    window.initialSections = JSON.parse(initialSections);
    window.initialTitle = post.title;
    window.initialMainImage = post.main_image;
    window.initialDesc = post.short_description;
</script>

<script>
    const addBtn = document.getElementById('add-section-btn');
    const container = document.getElementById('sections-container');
    const form = document.getElementById('blog-form');
    const jsonInput = document.getElementById('sections-json');
    const previewArea = document.getElementById('preview-area');
    
    // Inputs
    const titleInput = document.getElementById('title') as HTMLInputElement;
    const descInput = document.getElementById('short_description') as HTMLTextAreaElement;
    const mainImageInput = document.getElementById('main_image') as HTMLInputElement;

    let sectionCount = 0;

    // --- RENDER HELPERS ---
    const renderPreview = () => {
        if (!previewArea) return;

        let html = '';
        
        // Hero
        const titleVal = titleInput?.value || "Post Title";
        const descVal = descInput?.value || "Short description...";
        
        // For main image
        let mainImgSrc = (window as any).initialMainImage; 
        if (mainImageInput?.files && mainImageInput.files[0]) {
             mainImgSrc = URL.createObjectURL(mainImageInput.files[0]);
        }

        html += `
            <section class="h-[300px] relative flex items-end justify-center bg-cover bg-center" style="background-image: url('${mainImgSrc}');">
                <div class="absolute inset-0 bg-black/30"></div>
                <div class="relative z-10 text-center pb-10 px-6 max-w-4xl mx-auto">
                    <h1 class="text-2xl text-white font-light leading-tight mb-2">${titleVal}</h1>
                    <p class="text-white/80 text-sm font-light max-w-lg mx-auto">${descVal}</p>
                </div>
            </section>
            <article class="p-10 flex flex-col gap-8">
        `;

        // Sections
        const sectionElements = container?.querySelectorAll('.section-item');
        if (sectionElements) {
            sectionElements.forEach(el => {
                const element = el as HTMLElement;
                const typeSelector = element.querySelector('.type-selector') as HTMLSelectElement;
                const type = typeSelector.value;
                let content = '';
                
                if (type === 'title' || type === 'paragraph') {
                    const localInput = element.querySelector('.content-input') as HTMLInputElement;
                    content = localInput ? localInput.value : '';
                    if (type === 'title') html += `<h2 class="text-2xl font-light text-black-soft">${content}</h2>`;
                    if (type === 'paragraph') html += `<p class="text-base text-black-soft/70 font-light leading-relaxed whitespace-pre-line">${content}</p>`;
                } else if (type === 'image_single') {
                    const imgInput = element.querySelector('input[type="file"]') as HTMLInputElement;
                    const existingImg = element.dataset.existingImage1;
                    
                    let imgSrc = existingImg || 'https://placehold.co/600x400';
                    if (imgInput && imgInput.files && imgInput.files[0]) {
                        imgSrc = URL.createObjectURL(imgInput.files[0]);
                    }
                    html += `<img src="${imgSrc}" class="w-full h-auto object-cover rounded-sm" />`;
                } else if (type === 'image_double') {
                    const inputs = element.querySelectorAll('input[type="file"]');
                    const existingImg1 = element.dataset.existingImage1;
                    const existingImg2 = element.dataset.existingImage2;
                    
                    let src1 = existingImg1 || 'https://placehold.co/300x400';
                    let src2 = existingImg2 || 'https://placehold.co/300x400';

                    const input1 = inputs[0] as HTMLInputElement;
                    const input2 = inputs[1] as HTMLInputElement;

                    if (input1 && input1.files && input1.files[0]) src1 = URL.createObjectURL(input1.files[0]);
                    if (input2 && input2.files && input2.files[0]) src2 = URL.createObjectURL(input2.files[0]);
                    
                    html += `
                        <div class="grid grid-cols-2 gap-4">
                            <img src="${src1}" class="w-full h-[200px] object-cover rounded-sm" />
                            <img src="${src2}" class="w-full h-[200px] object-cover rounded-sm" />
                        </div>
                    `;
                }
            });
        }

        html += `</article>`;
        previewArea.innerHTML = html;
    };


    // --- SECTION LOGIC ---
    const getTemplate = (id, type = 'paragraph', content = '', existing1 = '', existing2 = '') => {
        let inputHtml = '';
        if (type === 'title') inputHtml = `<input type="text" class="content-input w-full border-b border-black-soft/20 py-2 focus:border-gold outline-none font-medium text-lg" placeholder="Enter section title" value="${content.replace(/"/g, '&quot;')}" />`;
        else if (type === 'paragraph') inputHtml = `<textarea class="content-input w-full border border-black-soft/10 p-3 focus:border-gold outline-none font-light text-sm resize-y min-h-[100px]" placeholder="Enter paragraph text...">${content}</textarea>`;
        else if (type === 'image_single') {
            inputHtml = `
                <div class="flex flex-col gap-2">
                    <label class="text-[10px] uppercase tracking-[0.2em] text-black-soft/60">Upload New Image (Overrides existing)</label>
                    <input type="file" name="section_${id}_img_1" accept="image/*" class="font-light text-xs text-black-soft/60" />
                    ${existing1 ? `<div class="text-[10px] text-black-soft/40">Current: <a href="${existing1}" target="_blank" class="underline">View</a></div>` : ''}
                </div>
            `;
        }
        else if (type === 'image_double') {
             inputHtml = `
                <div class="grid grid-cols-2 gap-4">
                     <div class="flex flex-col gap-2">
                        <label class="text-[10px] uppercase tracking-[0.2em] text-black-soft/60">Image Left</label>
                        <input type="file" name="section_${id}_img_1" accept="image/*" class="font-light text-xs text-black-soft/60" />
                        ${existing1 ? `<div class="text-[10px] text-black-soft/40">Current: <a href="${existing1}" target="_blank" class="underline">View</a></div>` : ''}
                    </div>
                     <div class="flex flex-col gap-2">
                        <label class="text-[10px] uppercase tracking-[0.2em] text-black-soft/60">Image Right</label>
                        <input type="file" name="section_${id}_img_2" accept="image/*" class="font-light text-xs text-black-soft/60" />
                        ${existing2 ? `<div class="text-[10px] text-black-soft/40">Current: <a href="${existing2}" target="_blank" class="underline">View</a></div>` : ''}
                    </div>
                </div>
            `;
        }

        return `
        <div class="section-item bg-beige-light/30 p-6 border border-black-soft/5 relative group" data-id="${id}" data-existing-image-1="${existing1}" data-existing-image-2="${existing2}">
            <button type="button" class="remove-section absolute top-4 right-4 text-black-soft/30 hover:text-red-500 transition-colors" onclick="this.closest('.section-item').remove(); window.dispatchEvent(new Event('preview-update'));">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            
            <div class="flex flex-col gap-4">
                <div class="flex flex-col gap-2 w-1/3">
                    <label class="text-[10px] uppercase tracking-[0.2em] text-black-soft/60">Section Type</label>
                    <select class="type-selector border-b border-black-soft/20 py-2 focus:border-gold outline-none bg-transparent font-light text-sm">
                        <option value="paragraph" ${type === 'paragraph' ? 'selected' : ''}>Paragraph (Text)</option>
                        <option value="title" ${type === 'title' ? 'selected' : ''}>Section Title</option>
                        <option value="image_single" ${type === 'image_single' ? 'selected' : ''}>Single Image</option>
                        <option value="image_double" ${type === 'image_double' ? 'selected' : ''}>Double Image</option>
                    </select>
                </div>

                <div class="content-area mt-2">
                    ${inputHtml}
                </div>
            </div>
        </div>
        `;
    };

    const addSection = (type = 'paragraph', content = '', existing1 = '', existing2 = '') => {
        sectionCount++;
        container.insertAdjacentHTML('beforeend', getTemplate(sectionCount, type, content, existing1, existing2));
        
        const newSection = container.lastElementChild;
        const select = newSection.querySelector('.type-selector');
        const contentArea = newSection.querySelector('.content-area');

        // Logic to re-render inputs on type change (same as new.astro but needs getInputsForType implementation)
        // For simplicity duplicating minimal logic here or reusing getTemplate parts
        // Real-world: Extract to a function.
        
        select.addEventListener('change', (e) => {
             const newType = e.target.value;
             // Reset content
             newSection.querySelector('.content-area').innerHTML = `
                ${newType === 'title' ? '<input type="text" class="content-input w-full border-b border-black-soft/20 py-2 focus:border-gold outline-none font-medium text-lg" placeholder="Enter section title" />' : ''}
                ${newType === 'paragraph' ? '<textarea class="content-input w-full border border-black-soft/10 p-3 focus:border-gold outline-none font-light text-sm resize-y min-h-[100px]" placeholder="Enter paragraph text..."></textarea>' : ''}
                ${newType.includes('image') ? '<div class="text-[10px] italic">Save to see image fields updated</div>' : ''} 
             `; 
             // Note: Switching types clears data.
             renderPreview();
        });

        // Listen for input changes in this section
        newSection.addEventListener('input', renderPreview);
    };

    // Initialize
    if (window.initialSections) {
        window.initialSections.forEach(s => {
            addSection(s.type, s.content, s.existing_image_1, s.existing_image_2);
        });
        renderPreview();
    }

    addBtn.addEventListener('click', () => {
        addSection();
        renderPreview();
    });

    // Global listeners
    titleInput.addEventListener('input', renderPreview);
    descInput.addEventListener('input', renderPreview);
    mainImageInput.addEventListener('change', renderPreview);
    window.addEventListener('preview-update', renderPreview);
    
    // Form Submit
    form.addEventListener('submit', (e) => {
        const sections = [];
        const sectionElements = container.querySelectorAll('.section-item');

        sectionElements.forEach((el) => {
            const type = el.querySelector('.type-selector').value;
            const id = el.dataset.id;
            
            const sectionData = { 
                type,
                existing_image_1: el.dataset.existingImage1,
                existing_image_2: el.dataset.existingImage2
            };

            if (type === 'title' || type === 'paragraph') {
                const input = el.querySelector('.content-input');
                sectionData.content = input ? input.value : '';
            } else if (type === 'image_single') {
                sectionData.image_1_key = `section_${id}_img_1`;
            } else if (type === 'image_double') {
                sectionData.image_1_key = `section_${id}_img_1`;
                sectionData.image_2_key = `section_${id}_img_2`;
            }

            sections.push(sectionData);
        });

        jsonInput.value = JSON.stringify(sections);
    });
</script>
